machine:
  services:
    - docker
    - postgresql

dependencies:
  override:
    # Supplment the docker container with additional dependencies
    - docker build -t $CIRCLE_PROJECT_REPONAME .

test:
  override:
    - "DATABASE_HOST=$(ip -4 addr show docker0 | grep -Po 'inet \\K[\\d.]+') \
       bash -c \
       'docker run \
       -v /home/ubuntu/$CIRCLE_PROJECT_REPONAME:/opt/src \
       --add-host=database:$DATABASE_HOST \
       $CIRCLE_PROJECT_REPONAME -e py27,py35,flake8'"
  post:
    - pip install codecov
    - codecov
